"""
Comprehensive PDF Generation Test
Tests all components needed for weekly reports
"""

import os
import sys
from datetime import datetime
import tempfile

print("=" * 70)
print("ðŸ§ª PDF GENERATION TEST SUITE")
print("=" * 70)

# Test 1: Check fpdf installation
print("\nðŸ“¦ Test 1: Checking fpdf library...")
try:
    from fpdf import FPDF
    print("âœ… fpdf is installed")
except ImportError as e:
    print(f"âŒ fpdf not installed: {e}")
    print("   Fix: pip install fpdf==1.7.2")
    sys.exit(1)

# Test 2: Check matplotlib for charts
print("\nðŸ“Š Test 2: Checking matplotlib...")
try:
    import matplotlib
    matplotlib.use('Agg')  # Non-interactive backend
    import matplotlib.pyplot as plt
    print("âœ… matplotlib is installed")
except ImportError as e:
    print(f"âŒ matplotlib not installed: {e}")
    print("   Fix: pip install matplotlib==3.8.2")
    sys.exit(1)

# Test 3: Check Groq AI (optional but recommended)
print("\nðŸ¤– Test 3: Checking Groq AI...")
groq_api_key = os.environ.get('GROQ_API_KEY')
if groq_api_key:
    try:
        from groq import Groq
        client = Groq(api_key=groq_api_key)
        response = client.chat.completions.create(
            model="llama-3.3-70b-versatile",
            messages=[{"role": "user", "content": "Say 'Working' in one word"}]
        )
        print(f"âœ… Groq AI is working: {response.choices[0].message.content.strip()}")
    except Exception as e:
        print(f"âš ï¸ Groq AI error: {e}")
        print("   PDF will work but without AI-powered analysis")
else:
    print("âš ï¸ GROQ_API_KEY not set")
    print("   PDF will work but without AI-powered analysis")

# Test 4: Create a simple test PDF
print("\nðŸ“„ Test 4: Creating simple test PDF...")
try:
    class TestPDF(FPDF):
        def header(self):
            self.set_font('Arial', 'B', 16)
            self.cell(0, 10, 'Test PDF Report', 0, 1, 'C')
        
        def footer(self):
            self.set_y(-15)
            self.set_font('Arial', 'I', 8)
            self.cell(0, 10, f'Page {self.page_no()}', 0, 0, 'C')
    
    pdf = TestPDF()
    pdf.add_page()
    pdf.set_font('Arial', '', 12)
    pdf.cell(0, 10, 'This is a test PDF generated successfully!', 0, 1)
    pdf.cell(0, 10, f'Generated at: {datetime.now().strftime("%Y-%m-%d %H:%M:%S")}', 0, 1)
    
    test_pdf_path = tempfile.mktemp(suffix='.pdf', prefix='test_')
    pdf.output(test_pdf_path)
    
    # Check file was created
    if os.path.exists(test_pdf_path):
        file_size = os.path.getsize(test_pdf_path)
        print(f"âœ… Test PDF created successfully")
        print(f"   Path: {test_pdf_path}")
        print(f"   Size: {file_size} bytes")
        
        # Clean up
        os.remove(test_pdf_path)
        print("âœ… Test PDF cleaned up")
    else:
        print("âŒ Test PDF was not created")
        sys.exit(1)
        
except Exception as e:
    print(f"âŒ Error creating test PDF: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# Test 5: Test with mock commodity data
print("\nðŸ’° Test 5: Creating PDF with mock commodity data...")
try:
    # Mock price history data
    mock_price_history = {
        'RC=F': [(datetime.now().isoformat(), 4500.0 + i*10) for i in range(20)],
        'KC=F': [(datetime.now().isoformat(), 250.0 + i*2) for i in range(20)],
        'CC=F': [(datetime.now().isoformat(), 9500.0 + i*50) for i in range(20)],
        'SB=F': [(datetime.now().isoformat(), 20.5 + i*0.2) for i in range(20)],
        'ZW=F': [(datetime.now().isoformat(), 550.0 + i*5) for i in range(20)],
        'ZL=F': [(datetime.now().isoformat(), 45.0 + i*0.5) for i in range(20)],
        'PO=F': [(datetime.now().isoformat(), 1050.0 + i*10) for i in range(20)],
    }
    
    mock_watchlist = {
        'RC=F': {'name': 'Robusta Coffee', 'type': 'Softs'},
        'KC=F': {'name': 'Arabica Coffee', 'type': 'Softs'},
        'CC=F': {'name': 'Cocoa', 'type': 'Softs'},
        'SB=F': {'name': 'Sugar No.11', 'type': 'Softs'},
        'ZW=F': {'name': 'Wheat', 'type': 'Grains'},
        'ZL=F': {'name': 'Soybean Oil', 'type': 'Oils'},
        'PO=F': {'name': 'Palm Oil', 'type': 'Oils'}
    }
    
    class CommodityReport(FPDF):
        def header(self):
            self.set_font('Arial', 'B', 20)
            self.set_text_color(0, 51, 102)
            self.cell(0, 15, 'ABU AUF', 0, 1, 'L')
            self.set_font('Arial', '', 10)
            self.set_text_color(100, 100, 100)
            self.cell(0, 5, 'Commodities Intelligence Report', 0, 1, 'L')
            self.ln(5)
        
        def footer(self):
            self.set_y(-15)
            self.set_font('Arial', 'I', 8)
            self.set_text_color(128, 128, 128)
            self.cell(0, 10, f'Page {self.page_no()}', 0, 0, 'C')
    
    pdf = CommodityReport()
    pdf.add_page()
    
    # Title
    pdf.set_font('Arial', 'B', 24)
    pdf.set_text_color(0, 51, 102)
    pdf.ln(20)
    pdf.cell(0, 15, 'Weekly Commodities Report', 0, 1, 'C')
    pdf.set_font('Arial', '', 14)
    pdf.set_text_color(0, 0, 0)
    pdf.cell(0, 10, f'Week Ending: {datetime.now().strftime("%B %d, %Y")}', 0, 1, 'C')
    pdf.ln(20)
    
    # Executive Summary
    pdf.set_font('Arial', 'B', 16)
    pdf.cell(0, 10, 'EXECUTIVE SUMMARY', 0, 1, 'L')
    pdf.set_font('Arial', '', 10)
    pdf.multi_cell(0, 6, 'This is a test report to verify PDF generation is working correctly. '
                         'In production, this section would contain AI-powered market analysis from Gemini.')
    
    # Price Performance Table
    pdf.add_page()
    pdf.set_font('Arial', 'B', 16)
    pdf.cell(0, 10, 'WEEKLY PRICE PERFORMANCE', 0, 1, 'L')
    pdf.ln(5)
    
    # Table header
    pdf.set_fill_color(0, 51, 102)
    pdf.set_text_color(255, 255, 255)
    pdf.set_font('Arial', 'B', 9)
    
    col_widths = [50, 30, 30, 30, 30, 20]
    headers = ['Commodity', 'Open', 'Close', 'High/Low', 'Change', '%']
    
    for i, header in enumerate(headers):
        pdf.cell(col_widths[i], 8, header, 1, 0, 'C', fill=True)
    pdf.ln()
    
    # Table data
    pdf.set_font('Arial', '', 9)
    pdf.set_text_color(0, 0, 0)
    
    for symbol, info in mock_watchlist.items():
        prices = [p for _, p in mock_price_history[symbol]]
        week_start = prices[0]
        week_end = prices[-1]
        week_high = max(prices)
        week_low = min(prices)
        week_change = week_end - week_start
        week_change_pct = (week_change / week_start * 100) if week_start else 0
        
        # Alternate row colors
        if list(mock_watchlist.keys()).index(symbol) % 2 == 0:
            pdf.set_fill_color(245, 245, 245)
        else:
            pdf.set_fill_color(255, 255, 255)
        
        pdf.cell(col_widths[0], 8, info['name'], 1, 0, 'L', fill=True)
        pdf.cell(col_widths[1], 8, f'${week_start:.2f}', 1, 0, 'C', fill=True)
        pdf.cell(col_widths[2], 8, f'${week_end:.2f}', 1, 0, 'C', fill=True)
        pdf.cell(col_widths[3], 8, f'${week_high:.2f}/${week_low:.2f}', 1, 0, 'C', fill=True)
        
        # Change with color
        if week_change_pct > 0:
            pdf.set_text_color(0, 128, 0)
        elif week_change_pct < 0:
            pdf.set_text_color(255, 0, 0)
        
        pdf.cell(col_widths[4], 8, f'{week_change:+.2f}', 1, 0, 'C', fill=True)
        pdf.cell(col_widths[5], 8, f'{week_change_pct:+.1f}%', 1, 0, 'C', fill=True)
        pdf.set_text_color(0, 0, 0)
        pdf.ln()
    
    # Save
    test_pdf_path = tempfile.mktemp(suffix='.pdf', prefix='commodity_test_')
    pdf.output(test_pdf_path)
    
    if os.path.exists(test_pdf_path):
        file_size = os.path.getsize(test_pdf_path)
        print(f"âœ… Commodity report PDF created successfully")
        print(f"   Path: {test_pdf_path}")
        print(f"   Size: {file_size} bytes")
        print(f"   Contains: {len(mock_watchlist)} commodities")
        
        # Keep this file so user can inspect it
        print(f"\nðŸ“ Test PDF saved for inspection:")
        print(f"   You can download and view: {test_pdf_path}")
        
    else:
        print("âŒ Commodity report PDF was not created")
        sys.exit(1)
        
except Exception as e:
    print(f"âŒ Error creating commodity report PDF: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# Test 6: Test chart generation
print("\nðŸ“ˆ Test 6: Testing chart generation...")
try:
    fig, ax = plt.subplots(figsize=(10, 6))
    
    # Generate test data
    timestamps = [datetime.now().timestamp() + i*3600 for i in range(24)]
    prices = [4500 + i*10 + (i%3)*20 for i in range(24)]
    
    times = [datetime.fromtimestamp(ts) for ts in timestamps]
    
    ax.plot(times, prices, linewidth=2, color='#2E86AB', marker='o', markersize=4)
    ax.fill_between(times, prices, alpha=0.3, color='#2E86AB')
    ax.set_title('Robusta Coffee - Test Chart', fontsize=14, fontweight='bold')
    ax.set_xlabel('Time', fontsize=10)
    ax.set_ylabel('Price (USD)', fontsize=10)
    ax.grid(True, alpha=0.3)
    
    chart_path = tempfile.mktemp(suffix='.png', prefix='chart_test_')
    plt.savefig(chart_path, format='png', dpi=150, bbox_inches='tight')
    plt.close()
    
    if os.path.exists(chart_path):
        file_size = os.path.getsize(chart_path)
        print(f"âœ… Chart generated successfully")
        print(f"   Path: {chart_path}")
        print(f"   Size: {file_size} bytes")
        os.remove(chart_path)
        print("âœ… Chart cleaned up")
    else:
        print("âŒ Chart was not created")
        
except Exception as e:
    print(f"âŒ Error creating chart: {e}")
    import traceback
    traceback.print_exc()

# Final Summary
print("\n" + "=" * 70)
print("ðŸ“‹ TEST SUMMARY")
print("=" * 70)

results = {
    "fpdf library": "âœ… Installed",
    "matplotlib library": "âœ… Installed",
    "AI Analysis": "âœ… Working" if groq_api_key else "âš ï¸ Not configured (optional)",
    "Simple PDF creation": "âœ… Working",
    "Commodity report PDF": "âœ… Working",
    "Chart generation": "âœ… Working"
}

for test, status in results.items():
    print(f"{test:.<50} {status}")

print("\n" + "=" * 70)
print("ðŸŽ‰ ALL PDF GENERATION TESTS PASSED!")
print("=" * 70)

print("\nâœ… Your monitor.py will be able to generate weekly PDF reports!")
print("\nðŸ“Œ Notes:")
print("   â€¢ PDF generation requires fpdf==1.7.2 (installed)")
print("   â€¢ Charts require matplotlib==3.8.2 (installed)")
print("   â€¢ AI analysis requires GROQ_API_KEY (optional)")
print("   â€¢ PDFs will be sent via Telegram on Fridays at 5 PM")

print("\nðŸš€ You're ready to deploy to Render!")
print("=" * 70)